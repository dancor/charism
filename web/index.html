<html>
<head>
<title>charism</title>
<style>
body {
  background: #227;
}
</style>
<script type="text/javascript"
 src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js">
</script>
<script type="text/javascript">
function last(a) {
  return a[a.length - 1];
}
function ord(c) {
  return c.charCodeAt(0);
}
function chr(i) {
  return String.fromCharCode(i);
}
function strToArr(s) {
  var r = [];
  for (var i = 0; i < s.length; i++) {
    r[i] = s[i];
  }
  return r;
}
function arrToStr(a) {
  return [].concat(a);
}
function shuffle(a) {
  for (var i = a.length - 1; i >= 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = a[j];
    a[j] = a[i];
    a[i] = tmp;
  }
  return a;
}
function putInFirstEmpty(a, c) {
  for (var i = 0; i < a.length; i++) {
    if (a[i].c == '@') {
      ltrSetC(a[i], c);
      return;
    }
  }
  throw('something went wrong in putInFirstEmpty');
}
function getParam(name) {
  // fixme: make this do decoding?
  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.href);
  if (results == null) {
    return null;
  } else {
    return results[1];
  }
}
function createLtr(x, y, ltrW, ltrH, c) {
  var img = document.createElement("img");
  img.src = "img/" + c + ".png";
  img.width = ltrW;
  img.height = ltrH;
  img.style.position = "absolute";
  img.style.left = x;
  img.style.top = y;
  document.body.appendChild(img);
  return {c: c, img: img};
}
function createLtrs(x, y, ltrW, ltrH, interSpaceW, cs, tooltip) {
  var r = [];
  for (var i = 0; i < cs.length; i++) {
    r[i] = createLtr(x + i * (ltrW + interSpaceW), y, ltrW, ltrH, cs[i]);
  }
  return r;
}
function ajaj(path, f) {
  r = new XMLHttpRequest();
  r.onreadystatechange = function() {
    if (r.readyState == 4) {
      f(JSON.parse(r.responseText));
    }
  }
  r.open("GET", "ajax/" + path, true);
  r.send();
}
function replicate(n, v) {
  var r = [];
  for (var i = 0; i < n; i++) {
    r[i] = v;
  }
  return r;
}
function ltrSetC(ltr, c) {
  ltr.c = c;
  ltr.img.src = "img/" + c + ".png";
}
function updateLtr(ltr, x, y, w, h, c) {
  ltr.img.width = w;
  ltr.img.height = w;
  ltr.img.style.left = x;
  ltr.img.style.top = y;
  ltrSetC(ltr, c);
}
function updateLtrs(ltrs, x, y, ltrW, ltrH, interSpaceW, cs) {
  for (var i = 0; i < ltrs.length; i++) {
    updateLtr(ltrs[i], x + i * (ltrW + interSpaceW), y, ltrW, ltrH, cs[i]);
  }
}
function ltrsToCs(ltrs) {
  var r = [];
  for (var i = 0; i < ltrs.length; i++) {
    r[i] = ltrs[i].c;
  }
  return r;
}
window.onload = function() {
  var tooltip = document.getElementById("tooltip");
  var helpBox = document.getElementById("help");

  var ltrNum = 7;
  var bagX = 8;
  var bagY = 8;
  var bagInterSpaceX = 8;
  var bagInterSpaceY = 8;
  var bagLtrW = 64;
  var bagLtrH = 64;

  var rackX = bagX;
  var rackY = bagY + bagLtrH + bagInterSpaceY;
  var rackInterSpaceX = 8;
  var rackInterSpaceY = 8;
  var rackLtrW = 64;
  var rackLtrH = 64;

  var wdsX = rackX;
  var wdsY = rackY + rackLtrH + rackInterSpaceY;
  var wdsInterSpaceX = 4;
  var wdsInterSpaceY = 4;
  var wdsColInterSpaceX = 16;
  var wdsLtrW = 32;
  var wdsLtrH = 32;

  var wdsRowNum = 0;

  var showSwap = false;

  var rack = createLtrs(rackX, rackY, rackLtrW, rackLtrH, rackInterSpaceX,
    replicate(ltrNum, "@"));
  var lang = "en";
  var langParam = getParam("lang");
  if (langParam == "de" || langParam == "es") {
    lang = langParam;
  }
  function showTooltip(x, y, content) {
    tooltip.style.left = 0;
    tooltip.style.top = 0;
    tooltip.innerHTML = content;
    if (x < tooltip.offsetWidth) {
      tooltip.style.left = x;
    } else {
      tooltip.style.left = x - tooltip.offsetWidth;
    }
    if (y < tooltip.offsetHeight) {
      tooltip.style.top = y;
    } else {
      tooltip.style.top = y - tooltip.offsetHeight;
    }
    tooltip.style.visibility = "visible";
  }
  function tooltipify(a, content) {
    a.addEventListener("mouseover", function(e) {
      showTooltip(e.clientX, e.clientY, content);}, true);
    a.addEventListener("mouseout", function(e) {
      tooltip.style.visibility = "hidden";}, true);
  }
  ajaj("get_round?lang=" + lang, function(resp) {
    var wdsRaw = resp[0];
    var bag = createLtrs(bagX, bagY, bagLtrW, bagLtrH, bagInterSpaceX,
      shuffle(strToArr(last(wdsRaw))));
    var wds = [];
    for (var i = 0; i < wdsRaw.length; i++) {
      var def = resp[1][i];
      wds[i] = {
        ltrs: createLtrs(wdsX, wdsY + i * (wdsLtrH + wdsInterSpaceY), 
          wdsLtrW, wdsLtrH, wdsInterSpaceX, wdsRaw[i]),
        wd: wdsRaw[i],
        got: false,
        def: def
        };
      for (var j = 0; j < wdsRaw[i].length; j++) {
        tooltipify(wds[i].ltrs[j].img, "<b>" + def + "</b>");
      }
    }
    function resize() {
      var x = wdsX;
      var y = wdsY;
      var wdsLtrWCur = wdsLtrW;
      var wdsLtrHCur = wdsLtrH;
      while (wdsLtrWCur >= 10) {
        var tooBig = false;
        for (var i = 0; i < wds.length; i++) {
          var wdL = wds[i].wd.length;
          if (x + wdL * (wdsLtrWCur + wdsInterSpaceX) - wdsInterSpaceX + 8 >= 
              window.innerWidth) {
            tooBig = true;
            break;
          }
          y += wdsInterSpaceY + wdsLtrHCur;
          if (y + wdsInterSpaceY + wdsLtrHCur > window.innerHeight) {
            x += wdL * (wdsLtrWCur + wdsInterSpaceX) - wdsInterSpaceX +
              wdsColInterSpaceX;
            y = wdsY;
          }
        }
        x = wdsX;
        y = wdsY;
        if (tooBig) {
          wdsLtrWCur--;
          wdsLtrHCur--;
          continue;
        }
        break;
      }
      colWidths = [];
      wdsRowNum = 0;
      for (var i = 0; i < wds.length; i++) {
        var curWd;
        if (wds[i].got ^ showSwap) {
          curWd = wds[i].wd;
        } else {
          curWd = replicate(wds[i].wd.length, "@");
        }
        updateLtrs(wds[i].ltrs, x, y, wdsLtrWCur, wdsLtrHCur, wdsInterSpaceX, 
          curWd);
        y += wdsInterSpaceY + wdsLtrHCur;
        if (y + wdsInterSpaceY + wdsLtrHCur > window.innerHeight) {
          var wdW = curWd.length * (wdsLtrWCur + wdsInterSpaceX) - 
            wdsInterSpaceX;
          colWidths = colWidths.concat([wdW]);
          if (wdsRowNum == 0) {
            wdsRowNum = i + 1;
          }
          x += wdW + wdsColInterSpaceX;
          y = wdsY;
        }
      }
    }
    function rackToBag() {
      for (var i = 0; i < rack.length; i++) {
        if (rack[i].c != '@') {
          putInFirstEmpty(bag, rack[i].c);
          ltrSetC(rack[i], '@');
        }
      }
    }
    function keypress(e) {
      var i = e.keyCode;
      var c;
      if (i == ordA) {
        c = '\u00C4';
      } else if (i == ordO) {
        c = '\u00D6';
      } else if (i == ordU) {
        c = '\u00DC';
      } else if (i == ordN) {
        c = '\u00D1';
      } else if (i == ordC) {
        c = '1';
      } else if (i == ordR) {
        c = '2';
      } else if (i == ordL) {
        c = '3';
      } else if (i >= 97 && i <= 122) {
        c = chr(i - 32);
      } else {
        return;
      }
      for (var j = 0; j < ltrNum; j++) {
        console.log(c);
        if (bag[j].c == c) {
          for (var k = 0; k <= ltrNum; k++) {
            if (rack[k].c == '@') {
              ltrSetC(rack[k], c);
              break;
            }
          }
          ltrSetC(bag[j], '@');
          break;
        }
      }
    }
    function keydown(e) {
      var i = e.keyCode % 128;
      if (i == 8 || i == 92) {
        for (var i = ltrNum - 1; i >= 0; i--) {
          if (rack[i].c != '@') {
            putInFirstEmpty(bag, rack[i].c);
            ltrSetC(rack[i], '@');
            break;
          }
        }
      } else if (i == 32) {
        updateLtrs(bag, bagX, bagY, bagLtrW, bagLtrH, bagInterSpaceX,
          arrToStr(shuffle(strToArr(ltrsToCs(bag)))));
      } else if (i == 13) {
        var rackWd = '';
        for (var i = 0; i < ltrNum; i++) {
          if (rack[i].c != '@') {
            rackWd += rack[i].c;
          }
        }
        for (var i = 0; i < wds.length; i++) {
          if (wds[i].wd == rackWd) {
            wds[i].got = true;
            rackToBag();
            resize();
            break;
          }
        }
      } else if (i == 27) {
        rackToBag();
      } else if (i == 63) {
        showSwap = !showSwap;
        resize();
      } else {
        //console.log(i);
      }
      return false;
    }
    window.addEventListener("resize", resize, true);
    window.addEventListener("keypress", keypress, true);
    window.addEventListener("keydown", keydown, true);
    tooltipify(helpBox, "<b>Use the keyboard to make words:<br>" +
"- Type letters to move letters to your working rack.<br>" + 
"- Press backspace or \\ to move one letter off your working rack.<br>" +
"- Press escape to move all letters off your working rack.<br>" +
"- Press enter when you have made a word.<br>" + 
"- Press spacebar to shuffle the letters on the source rack.<br>" +
"- Pless ? to show words you haven't gotten.<br>" +
"- Hover over words to see definitions.<br>" +
"- Reload the page (ctrl+r) to play another round.</b>");
    resize();
  }); 
};
</script>
</head>
<body>
<img id="help" src="img/help.png" align="right" />
<div id="tooltip" style="visibility:hidden;position:absolute;left:0px;top:0px;opacity:0.9;background:yellow;border-style:outset;border-color:orange;word-wrap:break-word;max-width:40em;z-index:1;">
</div>
</body>
</html>
